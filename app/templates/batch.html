{% extends "base.html" %}

{% block title %}Batch Verification - TTB Label Verifier{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <h1 class="mb-4">
            <i class="bi bi-folder-fill"></i> Batch Label Verification
        </h1>
        
        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <strong>Error:</strong> {{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form method="post" action="/ui/batch" enctype="multipart/form-data" id="batchForm">
                    <!-- ZIP Upload -->
                    <div class="mb-4">
                        <label for="batch_file" class="form-label fw-bold">
                            <i class="bi bi-file-zip"></i> Batch ZIP File *
                        </label>
                        <input 
                            type="file" 
                            class="form-control {% if error_field == 'batch_file' %}is-invalid{% endif %}" 
                            id="batch_file" 
                            name="batch_file" 
                            accept="application/zip,application/x-zip-compressed" 
                            required
                        >
                        <div class="form-text">
                            Upload a ZIP file containing label images (max {{ max_batch_size }} images)
                        </div>
                        {% if error_field == 'batch_file' %}
                        <div class="invalid-feedback d-block">
                            {{ error }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- ZIP Structure Info -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle"></i> ZIP File Structure
                        </h6>
                        <p class="mb-2">Your ZIP file should contain:</p>
                        <ul class="mb-0 small">
                            <li><strong>Images:</strong> JPEG or PNG files</li>
                            <li><strong>Ground Truth (optional):</strong> JSON files with same name as images
                                <ul>
                                    <li>Example: <code>label_001.jpg</code> + <code>label_001.json</code></li>
                                    <li>JSON format: <code>{"brand_name": "...", "abv": 7.5, ...}</code></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    
                    <hr class="my-4">
                    
                     <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="bi bi-cloud-upload"></i> Upload & Process Batch
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3 shadow-sm">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-clock-history"></i> Processing Time
                </h6>
                <p class="mb-0 small">
                    Batch processing is <strong>asynchronous</strong>. Your job will be submitted 
                    immediately, and you'll be redirected to a results page that updates live as 
                    each image completes. Expect approximately 10-30 seconds per image with Ollama.
                    You can close the results page and return later - results are retained for 1 hour.
                </p>
            </div>
        </div>
        
        <div class="card mt-3 shadow-sm">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-question-circle"></i> Example ZIP Structure
                </h6>
                <pre class="mb-0 small"><code>batch.zip
├── label_001.jpg
├── label_001.json   (optional)
├── label_002.jpg
├── label_002.json   (optional)
└── label_003.png</code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Form submission - show loading state
    document.getElementById('batchForm').addEventListener('submit', function() {
        const submitBtn = document.getElementById('submitBtn');
        if (!submitBtn.disabled) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing batch... This may take several minutes.';
        }
    });
</script>
{% endblock %}
