{% extends "base.html" %}

{% block title %}Verification Results - TTB Label Verifier{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Back button -->
        <div class="mb-3">
            <a href="/ui/verify" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> New Verification
            </a>
        </div>
        
        <h1 class="mb-4">
            <i class="bi bi-file-earmark-check"></i> Verification Results
        </h1>
        
        <!-- File Info -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-file-image"></i> {{ filename }}
                </h5>
                <p class="text-muted mb-0">
                    <small>
                        Processing Time: {{ "%.2f"|format(result.processing_time_seconds) }}s | 
                        Validation Level: {{ result.validation_level }}
                    </small>
                </p>
            </div>
        </div>
        
        <!-- Status Card -->
        <div class="card mb-4 shadow">
            <div class="card-body text-center p-4">
                <h2 class="mb-3">Compliance Status</h2>
                
                {% if result.status == 'COMPLIANT' %}
                <div class="status-badge compliant rounded-3 d-inline-block">
                    <i class="bi bi-check-circle-fill"></i> COMPLIANT
                </div>
                <p class="mt-3 mb-0 text-success">
                    This label meets all validation requirements.
                </p>
                
                {% elif result.status == 'NON_COMPLIANT' %}
                <div class="status-badge non-compliant rounded-3 d-inline-block">
                    <i class="bi bi-x-circle-fill"></i> NON-COMPLIANT
                </div>
                <p class="mt-3 mb-0 text-danger">
                    This label has {{ result.violations|length }} violation(s).
                </p>
                
                {% elif result.status == 'PARTIAL_VALIDATION' %}
                <div class="status-badge partial rounded-3 d-inline-block">
                    <i class="bi bi-exclamation-triangle-fill"></i> PARTIAL VALIDATION
                </div>
                <p class="mt-3 mb-0 text-warning">
                    Validation completed with warnings.
                </p>
                
                {% else %}
                <div class="status-badge error rounded-3 d-inline-block">
                    <i class="bi bi-question-circle-fill"></i> ERROR
                </div>
                <p class="mt-3 mb-0 text-muted">
                    {{ result.error or "An error occurred during validation." }}
                </p>
                {% endif %}
            </div>
        </div>
        
        <!-- Violations -->
        {% if result.violations %}
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-octagon"></i> Violations ({{ result.violations|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for violation in result.violations %}
                <div class="card violation-card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <span class="badge bg-danger me-2">{{ violation.type|upper }}</span>
                            {{ violation.field }}
                        </h6>
                        <p class="card-text mb-2">{{ violation.message }}</p>
                        
                        {% if violation.expected or violation.actual %}
                        <div class="row">
                            {% if violation.expected %}
                            <div class="col-md-6">
                                <small class="text-muted">Expected:</small>
                                <div><code>{{ violation.expected }}</code></div>
                            </div>
                            {% endif %}
                            
                            {% if violation.actual %}
                            <div class="col-md-6">
                                <small class="text-muted">Actual:</small>
                                <div><code>{{ violation.actual }}</code></div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Warnings -->
        {% if result.warnings %}
        <div class="alert alert-warning shadow-sm">
            <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle"></i> Warnings
            </h6>
            <ul class="mb-0">
                {% for warning in result.warnings %}
                <li>{{ warning }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <!-- Extracted Fields -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> Extracted Fields
                </h5>
            </div>
            <div class="card-body">
                {% if result.extracted_fields %}
                <div class="row">
                    {% for field, value in result.extracted_fields.items() %}
                    {% if value is not none and field != 'government_warning' %}
                    <div class="col-md-6 extracted-field">
                        <span class="field-label">{{ field|replace('_', ' ')|title }}:</span>
                        <span class="ms-2">
                            {% if value is mapping %}
                                {{ value }}
                            {% else %}
                                {{ value }}
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                    {% endfor %}
                    
                    {% if result.extracted_fields.government_warning %}
                    <div class="col-12 extracted-field mt-2">
                        <span class="field-label">Government Warning:</span>
                        <ul class="mb-0 mt-1">
                            <li>Present: {{ result.extracted_fields.government_warning.present }}</li>
                            {% if result.extracted_fields.government_warning.header_correct is not none %}
                            <li>Header Correct: {{ result.extracted_fields.government_warning.header_correct }}</li>
                            {% endif %}
                            {% if result.extracted_fields.government_warning.text_correct is not none %}
                            <li>Text Correct: {{ result.extracted_fields.government_warning.text_correct }}</li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No fields extracted.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Detailed Validation Results -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-data"></i> Detailed Validation Results
                </h5>
            </div>
            <div class="card-body">
                <!-- Structural Validation -->
                <h6 class="mb-3">Tier 1: Structural Validation</h6>
                {% if result.validation_results.structural %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Valid</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in result.validation_results.structural %}
                            <tr>
                                <td><strong>{{ item.field }}</strong></td>
                                <td>
                                    {% if item.valid %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-lg"></i> Valid
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-lg"></i> Invalid
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.error %}
                                    <span class="text-danger">{{ item.error }}</span>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No structural validation results.</p>
                {% endif %}
                
                <!-- Accuracy Validation -->
                {% if result.validation_results.accuracy %}
                <hr class="my-4">
                <h6 class="mb-3">Tier 2: Accuracy Validation</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Valid</th>
                                <th>Expected</th>
                                <th>Actual</th>
                                <th>Similarity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in result.validation_results.accuracy %}
                            <tr>
                                <td><strong>{{ item.field }}</strong></td>
                                <td>
                                    {% if item.valid %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-lg"></i> Valid
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-lg"></i> Invalid
                                    </span>
                                    {% endif %}
                                </td>
                                <td><code>{{ item.expected }}</code></td>
                                <td><code>{{ item.actual }}</code></td>
                                <td>
                                    {% if item.similarity_score %}
                                    {{ "%.1f"|format(item.similarity_score * 100) }}%
                                    {% else %}
                                    —
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Actions -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-between mb-4">
            <a href="/ui/verify" class="btn btn-primary">
                <i class="bi bi-arrow-repeat"></i> Verify Another Label
            </a>
            <a href="/ui/batch" class="btn btn-outline-primary">
                <i class="bi bi-folder-fill"></i> Try Batch Verification
            </a>
        </div>
    </div>
</div>
{% endblock %}
